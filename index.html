<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Berlin Christmas Markets</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            background: linear-gradient(135deg, #c41e3a 0%, #a01830 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .filters {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        label {
            font-weight: 500;
            margin-right: 8px;
        }

        select, input[type="checkbox"] {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
        }

        .checkbox-group {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #ffd700;
        }

        .content {
            display: flex;
            flex: 1;
            gap: 0;
            overflow: hidden;
        }

        #map {
            flex: 1;
            background: #e8e8e8;
        }

        .distance-panel {
            width: 300px;
            background: white;
            border-left: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            box-shadow: -2px 0 8px rgba(0,0,0,0.05);
        }

        .distance-panel-header {
            padding: 12px 16px;
            border-bottom: 1px solid #ddd;
            font-weight: 600;
            color: #333;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .distance-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .market-item {
            padding: 10px;
            margin-bottom: 8px;
            background: #f9f9f9;
            border-radius: 4px;
            border-left: 3px solid #c41e3a;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .market-item:hover {
            background: #f0f0f0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .market-item-name {
            font-weight: 600;
            font-size: 13px;
            color: #333;
            margin-bottom: 4px;
        }

        .market-item-distance {
            font-size: 12px;
            color: #c41e3a;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .market-item-location {
            font-size: 12px;
            color: #666;
        }

        .distance-empty {
            padding: 20px;
            text-align: center;
            color: #999;
            font-size: 13px;
        }

        .info-panel {
            background: white;
            padding: 12px 20px;
            border-top: 1px solid #ddd;
            font-size: 14px;
            color: #666;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .marker-popup {
            font-family: inherit;
        }

        .marker-popup h3 {
            margin: 0 0 8px 0;
            color: #c41e3a;
            font-size: 16px;
        }

        .marker-popup p {
            margin: 4px 0;
            font-size: 13px;
        }

        .marker-popup .type-badge {
            display: inline-block;
            background: #ffd700;
            color: #333;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
            margin-top: 6px;
        }

        .toggle-panel-btn {
            display: none;
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: #c41e3a;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.2s ease;
        }

        .toggle-panel-btn:hover {
            background: #a01830;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .toggle-panel-btn:active {
            transform: scale(0.95);
        }

        .panel-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }

        .panel-overlay.active {
            display: block;
        }

        .distance-panel-close {
            display: none;
        }

        @media (max-width: 768px) {
            .toggle-panel-btn {
                display: block;
            }

            .content {
                position: relative;
            }

            .distance-panel {
                position: absolute;
                top: 0;
                right: 0;
                bottom: 0;
                width: 100%;
                max-width: 320px;
                height: 100%;
                z-index: 1001;
                transform: translateX(100%);
                transition: transform 0.3s ease;
                border-left: 1px solid #ddd;
            }

            .distance-panel.active {
                transform: translateX(0);
            }

            .distance-panel-close {
                display: none;
                position: absolute;
                top: 5px;
                right: 5px;
                background: none;
                border: none;
                font-size: 20px;
                cursor: pointer;
                color: #666;
                padding: 4px 8px;
                z-index: 1002;
            }

            .distance-panel.active .distance-panel-close {
                display: block;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>üéÑ Berlin Christmas Markets</h1>
        <div class="filters">
            <div style="display: flex; align-items: center; gap: 8px;">
                <label for="dateFilter">Open on:</label>
                <input type="date" id="dateFilter">
            </div>
        </div>
    </header>

    <div class="content">
        <div id="map"></div>
        <div class="panel-overlay" id="panelOverlay"></div>
        <button class="toggle-panel-btn" id="togglePanelBtn">üìç Nearby Markets</button>
        <div class="distance-panel">
            <button class="distance-panel-close" id="closePanelBtn">‚úï</button>
            <div class="distance-panel-header">üìç Nearby Markets</div>
            <div class="distance-list" id="distanceList">
                <div class="distance-empty">Enable location to see nearby markets</div>
            </div>
        </div>
    </div>
    
    <div class="info-panel">
        <span id="markerCount">Loading markets...</span>
        <span style="color: #999; font-size: 13px;">‚ù§Ô∏è made with love by Dariusz</span>
    </div>

    <script>
        let markets = [];
        let userLocation = null;
        
        fetch('markets.json')
            .then(res => {
                if (!res.ok) throw new Error('Network response was not ok');
                return res.json();
            })
            .then(data => {
                markets = data.map(m => {
                    if (m.lat !== undefined) m.lat = Number(m.lat);
                    if (m.lng !== undefined) m.lng = Number(m.lng);
                    return m;
                });
                updateMarkers();
            })
            .catch(err => {
                console.error('Failed to load markets.json', err);
                document.getElementById('markerCount').textContent = 'Failed to load markets.json';
            });

        const map = L.map('map').setView([52.52, 13.405], 11);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        const markers = {};
        const defaultColor = '#c41e3a';

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function createMarker(market) {
            const color = defaultColor;
            const svgIcon = `
                <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="16" cy="16" r="14" fill="${color}" stroke="white" stroke-width="2"/>
                    <circle cx="16" cy="12" r="2.5" fill="white"/>
                </svg>
            `;
            
            const icon = L.divIcon({
                html: svgIcon,
                iconSize: [32, 32],
                iconAnchor: [16, 16],
                popupAnchor: [0, -16],
                className: 'market-marker'
            });

            const popup = `
                <div class="marker-popup">
                    <h3>${market.name}</h3>
                    <p><strong>Location:</strong> ${market.loc || ''}</p>
                    <p><strong>Dates:</strong> ${Array.isArray(market.dates) ? market.dates.join(', ') : (market.start && market.end ? `${market.start} ‚Äî ${market.end}` : '')}</p>
                    <p>${market.description || ''}</p>
                </div>
            `;

            const marker = L.marker([market.lat, market.lng], { icon })
                .bindPopup(popup)
                .addTo(map);

            return marker;
        }

        function isOpenOn(market, dateStr) {
            if (!dateStr) return true;

            if (Array.isArray(market.specialOpen) && market.specialOpen.includes(dateStr)) return true;
            if (Array.isArray(market.closed) && market.closed.includes(dateStr)) return false;

            if (Array.isArray(market.dates) && market.dates.length) {
                return market.dates.includes(dateStr);
            }

            if (market.start || market.end) {
                const d = new Date(dateStr);
                if (market.start) {
                    const start = new Date(market.start);
                    if (d < start) return false;
                }
                if (market.end) {
                    const end = new Date(market.end);
                    if (d > end) return false;
                }

                if (Array.isArray(market.daysOfWeek) && market.daysOfWeek.length) {
                    const dow = d.getDay();
                    return market.daysOfWeek.includes(dow);
                }

                return true;
            }

            return false;
        }

        function updateDistancePanel() {
            const distanceList = document.getElementById('distanceList');
            
            if (!userLocation) {
                distanceList.innerHTML = '<div class="distance-empty">Enable location to see nearby markets</div>';
                return;
            }

            const dateFilterVal = document.getElementById('dateFilter').value;
            const openMarkets = markets.filter(m => isOpenOn(m, dateFilterVal));

            if (openMarkets.length === 0) {
                distanceList.innerHTML = '<div class="distance-empty">No markets open on this date</div>';
                return;
            }

            const marketsWithDistance = openMarkets
                .map(market => ({
                    ...market,
                    distance: calculateDistance(userLocation.lat, userLocation.lng, market.lat, market.lng)
                }))
                .sort((a, b) => a.distance - b.distance);

            distanceList.innerHTML = marketsWithDistance.map(market => `
                <div class="market-item" onclick="map.setView([${market.lat}, ${market.lng}], 15);">
                    <div class="market-item-name">${market.name}</div>
                    <div class="market-item-distance">üìç ${market.distance.toFixed(1)} km away</div>
                    <div class="market-item-location">${market.loc || ''}</div>
                </div>
            `).join('');
        }

        function updateMarkers() {
            const dateFilterVal = document.getElementById('dateFilter').value;
            let visibleCount = 0;

            markets.forEach(market => {
                const dateOk = isOpenOn(market, dateFilterVal);

                if (dateOk) {
                    visibleCount++;
                    const lat = Number(market.lat);
                    const lng = Number(market.lng);
                    if (Number.isFinite(lat) && Number.isFinite(lng)) {
                        market.lat = lat; market.lng = lng;
                        if (!markers[market.name]) markers[market.name] = createMarker(market);
                        else markers[market.name].addTo(map);
                    }
                } else {
                    if (markers[market.name]) map.removeLayer(markers[market.name]);
                }
            });

            document.getElementById('markerCount').textContent = `${visibleCount} of ${markets.length} markets are happening today`;
            updateDistancePanel();
        }

        function addUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        const santaIcon = L.divIcon({
                            html: '<div style="font-size: 32px; filter: drop-shadow(2px 2px 3px rgba(0,0,0,0.3));">üéÖ</div>',
                            iconSize: [32, 32],
                            iconAnchor: [16, 16],
                            className: 'santa-marker'
                        });

                        L.marker([userLocation.lat, userLocation.lng], { icon: santaIcon })
                            .bindPopup('üìç You are here!')
                            .addTo(map);

                        map.setView([userLocation.lat, userLocation.lng], 13);
                        updateDistancePanel();
                    },
                    function(error) {
                        console.log('Location access denied or unavailable');
                    }
                );
            }
        }

        document.getElementById('dateFilter').addEventListener('change', updateMarkers);

        // Mobile panel controls
        const togglePanelBtn = document.getElementById('togglePanelBtn');
        const closePanelBtn = document.getElementById('closePanelBtn');
        const panelOverlay = document.getElementById('panelOverlay');
        const distancePanel = document.querySelector('.distance-panel');

        function openPanel() {
            distancePanel.classList.add('active');
            panelOverlay.classList.add('active');
        }

        function closePanel() {
            distancePanel.classList.remove('active');
            panelOverlay.classList.remove('active');
        }

        togglePanelBtn.addEventListener('click', openPanel);
        closePanelBtn.addEventListener('click', closePanel);
        panelOverlay.addEventListener('click', closePanel);

        const today = new Date().toISOString().split('T')[0];
        document.getElementById('dateFilter').value = today;

        updateMarkers();
        addUserLocation();
    </script>
</body>
</html>
